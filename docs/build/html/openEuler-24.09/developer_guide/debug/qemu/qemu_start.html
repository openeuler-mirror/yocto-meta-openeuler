<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>QEMU使用 &mdash; openEuler Embedded在线文档 24.03 documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/tabs.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/custom.css" type="text/css" />
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/tabs.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="QEMU调试" href="qemu_debug.html" />
    <link rel="prev" title="QEMU仿真器的使用" href="index.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> openEuler Embedded在线文档
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">介绍与概述</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../introduction/index.html">总体介绍</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started/index.html">快速上手</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../releases/index.html">版本说明</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../test_data/index.html">测试数据</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">指导手册</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../user_guide/index.html">用户使用指导</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../index.html">开发及贡献指导</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../code_download_compile.html">下载编译指导</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../develop/index.html">代码开发指导</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html">功能调试指导</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../gdb_guide/index.html">基于GDB Server的调试指南</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="index.html">QEMU仿真器的使用</a><ul class="current">
<li class="toctree-l4 current"><a class="current reference internal" href="#">QEMU使用</a><ul>
<li class="toctree-l5"><a class="reference internal" href="#id1">1. 安装QEMU</a></li>
<li class="toctree-l5"><a class="reference internal" href="#openeuler-embedded">2. 获取openEuler Embedded镜像</a></li>
<li class="toctree-l5"><a class="reference internal" href="#id3">3. 使用QEMU运行镜像</a></li>
<li class="toctree-l5"><a class="reference internal" href="#qemu-enable-net">4. 使能网络场景</a></li>
<li class="toctree-l5"><a class="reference internal" href="#id7">5. 使能共享文件系统场景</a></li>
<li class="toctree-l5"><a class="reference internal" href="#id8">6. 使能运行虚拟磁盘场景</a></li>
<li class="toctree-l5"><a class="reference internal" href="#id9">附录：QEMU常用的启动参数</a></li>
</ul>
</li>
<li class="toctree-l4"><a class="reference internal" href="qemu_debug.html">QEMU调试</a></li>
<li class="toctree-l4"><a class="reference internal" href="qemu_monitor.html">QEMU控制台</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../commit.html">代码提交指导</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../contribute_doc.html">文档提交指导</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq/index.html">常见问题</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../references/index.html">参考文档</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">openEuler Embedded在线文档</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../index.html">开发及贡献指导</a> &raquo;</li>
          <li><a href="../index.html">功能调试指导</a> &raquo;</li>
          <li><a href="index.html">QEMU仿真器的使用</a> &raquo;</li>
      <li>QEMU使用</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="qemu">
<span id="qemu-start"></span><h1>QEMU使用<a class="headerlink" href="#qemu" title="Permalink to this headline">¶</a></h1>
<p>本文档主要介绍如何通过qemu运行openEuler Embedded，以及如何使能网络，如何共享宿主机的文件。下面以arm64为例，其它架构与之类似。</p>
<section id="id1">
<h2>1. 安装QEMU<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><p>方法一：通过以下命令安装QEMU</p>
<blockquote>
<div><div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-0-0-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-0-0-0" name="0-0" role="tab" tabindex="0">openEuler</button><button aria-controls="panel-0-0-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-0-0-1" name="0-1" role="tab" tabindex="-1">Ubuntu</button><button aria-controls="panel-0-0-2" aria-selected="false" class="sphinx-tabs-tab" id="tab-0-0-2" name="0-2" role="tab" tabindex="-1">SUSELeap15.4</button></div><div aria-labelledby="tab-0-0-0" class="sphinx-tabs-panel" id="panel-0-0-0" name="0-0" role="tabpanel" tabindex="0"><p>$ sudo yum install qemu-system-aarch64</p>
</div><div aria-labelledby="tab-0-0-1" class="sphinx-tabs-panel" hidden="true" id="panel-0-0-1" name="0-1" role="tabpanel" tabindex="0"><p>$ sudo apt-get install qemu-system-arm</p>
</div><div aria-labelledby="tab-0-0-2" class="sphinx-tabs-panel" hidden="true" id="panel-0-0-2" name="0-2" role="tabpanel" tabindex="0"><p>$ sudo zepper install qemu-arm</p>
</div></div>
</div></blockquote>
<p>方法二：基于openEuler社区 <a class="reference external" href="https://gitee.com/openeuler/qemu/tree/stable-5.0/">QEMU</a> 代码自行编译</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>首先下载对应的代码并切换到stable-5.0分支：</p></li>
</ol>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>git clone https://gitee.com/openeuler/qemu.git qemu
<span class="gp">$ </span><span class="nb">cd</span> qemu
<span class="gp">$ </span>git checkout -b stable-5.0 remotes/origin/stable-5.0
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li><p>编译生成对应的二进制：</p></li>
</ol>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>./configure --target-list<span class="o">=</span>arm-softmmu,aarch64-softmmu --disable-werror
<span class="gp">$ </span>make -j <span class="m">8</span>
<span class="gp">$ </span>make install <span class="c1">#调试不需要</span>
</pre></div>
</div>
<p>编译完成后会生成 <code class="docutils literal notranslate"><span class="pre">arm-softmmu/qemu-system-arm</span></code>、<code class="docutils literal notranslate"><span class="pre">aarch64-softmmu/qemu-system-aarch64</span></code> 两个文件。</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<ul>
<li><div class="line-block">
<div class="line">configure 执行过程中，可能会有诸如 <code class="docutils literal notranslate"><span class="pre">glib-2.48</span> <span class="pre">gthread-2.0</span> <span class="pre">is</span> <span class="pre">required</span> <span class="pre">to</span> <span class="pre">compile</span> <span class="pre">QEMU</span></code> 的失败打印，请按照提示自行安装升级对应的软件包。</div>
</div>
</li>
<li><div class="line-block">
<div class="line">configure 时可以通过不同的参数来 <code class="docutils literal notranslate"><span class="pre">enable/disable</span></code> 一些 QEMU 的特性或编译选项，如示例中增加的 <code class="docutils literal notranslate"><span class="pre">--disable-werror</span></code> 可以允许编译 warning；</div>
<div class="line">如想要体验 openEuler Embedded 共享文件系统场景，需要在 configure 时增加 <code class="docutils literal notranslate"><span class="pre">--enable-virtfs</span></code> 来使能对应功能。</div>
</div>
</li>
</ul>
</div>
</div></blockquote>
</div></blockquote>
</section>
<section id="openeuler-embedded">
<h2>2. 获取openEuler Embedded镜像<a class="headerlink" href="#openeuler-embedded" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><p>参照 <a class="reference internal" href="../../../getting_started/index.html#getting-started"><span class="std std-ref">快速上手</span></a> 部分，使用 <a class="reference external" href="https://gitee.com/openeuler/yocto-meta-openeuler">yocto-meta-openeuler</a> 项目构建 ARM64 QEMU 镜像，或者在 <a class="reference external" href="http://121.36.84.172/dailybuild/openEuler-Mainline/">dailybuild</a> 下载镜像。</p>
</div></blockquote>
</section>
<section id="id3">
<h2>3. 使用QEMU运行镜像<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><p>一个简单的qemu执行命令如下：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>qemu-system-aarch64 -M virt-4.0 -m 1G -cpu cortex-a57 -nographic <span class="se">\</span>
    -kernel zImage <span class="se">\</span>
    -initrd openeuler-image-qemu-aarch64-*.rootfs.cpio.gz
</pre></div>
</div>
<p>执行之后等待OS加载完成，很快就能看到登陆提示：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">Authorized uses only. All activity may be monitored and reported.</span>
<span class="go">qemu-aarch64 login:</span>
</pre></div>
</div>
<p>这意味您已经成功在机器上启动了openEuler Embedded的系统，但此时无法配置网络，也无法通过共享文件系统的方式访问宿主机的文件，接下来会分别介绍如何使能网络和共享文件系统。</p>
</div></blockquote>
</section>
<section id="qemu-enable-net">
<span id="id4"></span><h2>4. 使能网络场景<a class="headerlink" href="#qemu-enable-net" title="Permalink to this headline">¶</a></h2>
<section id="qemu-local-network">
<span id="id5"></span><h3>使能本地网络<a class="headerlink" href="#qemu-local-network" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><p>通过 QEMU 的 <code class="docutils literal notranslate"><span class="pre">virtio-net</span></code> 和宿主机上的虚拟网卡，可以实现宿主机和 openEuler Embedded 之间的网络通信，之后可以通过 <code class="docutils literal notranslate"><span class="pre">scp</span></code> 实现宿主机和 openEuler Embedded 传输文件。</p>
<p><strong>Step1：宿主上建立虚拟网卡</strong></p>
<blockquote>
<div><p>在宿主机上需要建立名为tap0的虚拟网卡，可以借助脚本实现，创建 <code class="file docutils literal notranslate"><span class="pre">/etc/qemu-ifup</span></code> 脚本，具体内容如下：</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-1-VWJ1bnR1" aria-selected="true" class="sphinx-tabs-tab code-tab group-tab" id="tab-1-VWJ1bnR1" name="VWJ1bnR1" role="tab" tabindex="0">Ubuntu</button><button aria-controls="panel-1-U1VTRUxlYXAxNS40" aria-selected="false" class="sphinx-tabs-tab code-tab group-tab" id="tab-1-U1VTRUxlYXAxNS40" name="U1VTRUxlYXAxNS40" role="tab" tabindex="-1">SUSELeap15.4</button></div><div aria-labelledby="tab-1-VWJ1bnR1" class="sphinx-tabs-panel code-tab group-tab" id="panel-1-VWJ1bnR1" name="VWJ1bnR1" role="tabpanel" tabindex="0"><div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
ifconfig <span class="nv">$1</span> <span class="m">192</span>.168.10.1 up
</pre></div>
</div>
</div><div aria-labelledby="tab-1-U1VTRUxlYXAxNS40" class="sphinx-tabs-panel code-tab group-tab" hidden="true" id="panel-1-U1VTRUxlYXAxNS40" name="U1VTRUxlYXAxNS40" role="tabpanel" tabindex="0"><div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
ip tuntap add dev <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> mode tap
ip link <span class="nb">set</span> dev <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> up
ip addr add <span class="m">192</span>.168.10.1/24 dev <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span>
</pre></div>
</div>
</div></div>
<p>其执行需要root权限：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>chmod a+x /etc/qemu-ifup
</pre></div>
</div>
<p>通过 <code class="file docutils literal notranslate"><span class="pre">qemu-ifup</span></code> 脚本，宿主机上将创建名为tap0的虚拟网卡，地址为 <code class="docutils literal notranslate"><span class="pre">192.168.10.1</span></code>。</p>
</div></blockquote>
<p><strong>Step2：启动QEMU时添加netdev</strong></p>
<blockquote>
<div><p>针对aarch64(ARM Cortex A57)，运行如下命令：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>qemu-system-aarch64 -M virt-4.0 -m 1G -cpu cortex-a57 -nographic <span class="se">\</span>
   -kernel zImage <span class="se">\</span>
   -initrd openeuler-image-qemu-aarch64-*.rootfs.cpio.gz <span class="se">\</span>
   -device virtio-net-device,netdev<span class="o">=</span>tap0 <span class="se">\</span>
   -netdev tap,id<span class="o">=</span>tap0,script<span class="o">=</span>/etc/qemu-ifup
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>如果宿主机是Ubuntu，则运行上述命令可能会出现could not configure /dev/net/tun: Operation not permitted的错误。此时，用户需要sudo权限执行上述命令，才能正常运行。</p>
</div>
</div></blockquote>
<p><strong>Step3：配置openEuler Embedded网卡</strong></p>
<blockquote>
<div><p>openEuler Embedded登陆后，默认会为 eth0 配置地址 <code class="docutils literal notranslate"><span class="pre">192.168.10.8</span></code>：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">qemu-aarch64 ~ # ifconfig</span>
<span class="go">eth0      ... ...</span>
<span class="go">          inet addr:192.168.10.8  Bcast:0.0.0.0  Mask:255.255.255.0</span>
</pre></div>
</div>
<p>也可以通过 <code class="docutils literal notranslate"><span class="pre">ifconfig</span></code> 手动配置新的地址，如：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ifconfig eth0 <span class="m">192</span>.168.10.2
</pre></div>
</div>
</div></blockquote>
<p><strong>Step4：确认网络连通</strong></p>
<blockquote>
<div><p>在openEuler Embedded中，执行如下命令：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ping <span class="m">192</span>.168.10.1
</pre></div>
</div>
<p>如能ping通，则宿主机和openEuler Embedded之间的网络是连通的。</p>
</div></blockquote>
</div></blockquote>
</section>
<section id="qemu-internet-nat">
<span id="id6"></span><h3>使能互联网<a class="headerlink" href="#qemu-internet-nat" title="Permalink to this headline">¶</a></h3>
<p>如果宿主机可以与互联网连接，则可以通过NAT模式，与互联网连接。</p>
<blockquote>
<div><p><strong>Step1：在宿主机添加新的网桥</strong></p>
<p>NAT模式的网络包转发的流程如下：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>出栈
<span class="go">虚拟机网卡（eth0）-&gt; 虚拟机网卡（vnet0）-&gt;网桥（br）---- iptable forward -----宿主机网卡（enp1s0）-&gt;发出</span>
<span class="gp"># </span>入栈
<span class="go">虚拟机网卡（eth0）&lt;- 虚拟机网卡（vnet0）&lt;-网桥（br）---- iptable forward -----宿主机网卡（enp1s0）&lt;-收到</span>
</pre></div>
</div>
<p>因此，首先需要在宿主机上添加一个新的网桥，如下：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>新增一个网桥
<span class="gp">$ </span>brctl addbr br_qemu
<span class="gp"># </span>网桥作为QEMU中openEuler Embedded的网关，需要配置IP地址
<span class="gp">$ </span>ifconfig br_qemu <span class="m">192</span>.168.122.1/24
<span class="gp"># </span>启动网桥
<span class="gp">$ </span>ifconfig br_qemu up
<span class="gp"># </span>将ip forward功能打开
<span class="gp">$ </span><span class="nb">echo</span> <span class="m">1</span> &gt;&gt; /proc/sys/net/ipv4/ip_forward
</pre></div>
</div>
<p>其中，网桥名称 <code class="docutils literal notranslate"><span class="pre">br_qemu</span></code> 可以被更改，IP地址可以更换为任意的未被占用的局域网地址。</p>
<p><strong>Step2：配置iptables</strong></p>
<p>在宿主机中，执行如下命令：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>iptables -A FORWARD -i br_qemu -o enp1s0 -j ACCEPT
<span class="gp">$ </span>iptables -A FORWARD -o br_qemu -i enp1s0 -j ACCEPT
<span class="gp">$ </span>iptables -t nat -A POSTROUTING -s <span class="m">192</span>.168.122.0/24 -j MASQUERADE <span class="c1"># NAT地址转换</span>
</pre></div>
</div>
<p>其中，enp1s0为宿主机的网卡名称，需要根据实际情况进行修改。</p>
<p><strong>Step3：启动QEMU时添加netdev</strong></p>
<p>以aarch64(ARM Cortex A53)为例，运行如下命令：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>sudo qemu-system-aarch64 -M virt,gic-version<span class="o">=</span><span class="m">3</span> -m 1G -cpu cortex-a53 <span class="se">\</span>
   -nographic -smp <span class="m">4</span> -kernel zImage -dtb qemu_mcs.dtb <span class="se">\</span>
   -netdev bridge,br<span class="o">=</span>br_qemu,id<span class="o">=</span>net0 -device virtio-net-pci,netdev<span class="o">=</span>net0 <span class="se">\</span>
   -initrd rootfs.cpio.gz -nographic
</pre></div>
</div>
<p>其中， <code class="docutils literal notranslate"><span class="pre">-netdev</span></code> 选项中 <code class="docutils literal notranslate"><span class="pre">br</span></code> 参数为宿主机上新建的网桥名称。
<code class="docutils literal notranslate"><span class="pre">-device</span></code> 选项中 <code class="docutils literal notranslate"><span class="pre">netdev</span></code> 参数为 <code class="docutils literal notranslate"><span class="pre">-netdev</span></code> 指定的 <code class="docutils literal notranslate"><span class="pre">id</span></code>，
指定了设备应该连接到的后端。</p>
<p><strong>Step4：配置openEuler Embedded网卡</strong></p>
<p>openEuler Embedded登陆后，用 <code class="docutils literal notranslate"><span class="pre">ifconfig</span></code> 查看网卡名称，如 <code class="docutils literal notranslate"><span class="pre">eth0</span></code> 。
执行如下命令配置网卡的IP地址和ip route的默认网关：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ifconfig enp0s1 <span class="m">192</span>.168.122.11 netmask <span class="m">255</span>.255.255.0
<span class="gp">$ </span>ip route add default via <span class="m">192</span>.168.122.1 dev enp0s1
</pre></div>
</div>
<p>其中，192.168.122.11可以更改为任意的未被占用的局域网地址。但是，需要保证与宿主机的网桥在同一个网段。
<code class="docutils literal notranslate"><span class="pre">ip</span> <span class="pre">route</span></code> 添加默认网关的作用是，当openEuler Embedded需要访问互联网时，将数据包转发到宿主机的网桥上，再由宿主机的网桥转发到互联网。</p>
<p><strong>Step5：配置DNS</strong></p>
<p>在openEuler Embedded中，执行如下命令：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>修改DNS配置文件
<span class="gp">$ </span>vi /etc/resolv.conf
<span class="gp"># </span>添加DNS服务器地址
<span class="gp">$ </span>nameserver <span class="m">1</span>.2.3.4
</pre></div>
</div>
<p><strong>Step6：确认网络连通</strong></p>
<p>在openEuler Embedded中，执行如下命令：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ping www.baidu.com
</pre></div>
</div>
<p>如能ping通，则说明openEuler Embedded可以访问互联网。</p>
</div></blockquote>
</section>
</section>
<section id="id7">
<h2>5. 使能共享文件系统场景<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><p>通过共享文件系统，可以使得运行 QEMU 仿真器的宿主机和 openEuler Embedded 共享文件，这样在宿主机上交叉编译的程序，拷贝到共享目录中，即可在 openEuler Embedded 上运行。注意 QEMU 必须支持 virtfs，即配置了 <code class="docutils literal notranslate"><span class="pre">--enable-virtfs</span></code>。</p>
<p>假设将宿主机的 <code class="docutils literal notranslate"><span class="pre">/tmp</span></code> 目录作为共享目录，并事先在其中创建了名为 <code class="file docutils literal notranslate"><span class="pre">hello_openeuler.txt</span></code> 的文件，使能共享文件系统功能的操作指导如下：</p>
<p><strong>Step1：启动QEMU时添加fsdev</strong></p>
<blockquote>
<div><p>针对aarch64(ARM Cortex A57)，运行如下命令：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>qemu-system-aarch64 -M virt-4.0 -m 1G -cpu cortex-a57 -nographic <span class="se">\</span>
    -kernel zImage <span class="se">\</span>
    -initrd openeuler-image-qemu-aarch64-*.rootfs.cpio.gz <span class="se">\</span>
    -device virtio-9p-device,fsdev<span class="o">=</span>fs1,mount_tag<span class="o">=</span>host <span class="se">\</span>
    -fsdev local,security_model<span class="o">=</span>passthrough,id<span class="o">=</span>fs1,path<span class="o">=</span>/tmp
</pre></div>
</div>
</div></blockquote>
<p><strong>Step2：映射文件系统</strong></p>
<blockquote>
<div><p>在 openEuler Embedded 启动并登录之后，需要运行如下命令，映射(mount)共享文件系统：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span><span class="nb">cd</span> /tmp
<span class="gp">$ </span>mkdir host
<span class="gp">$ </span>mount -t 9p -o <span class="nv">trans</span><span class="o">=</span>virtio,version<span class="o">=</span>9p2000.L host /tmp/host
</pre></div>
</div>
<p>即把共享文件系统映射到 openEuler Embedded 的 <code class="docutils literal notranslate"><span class="pre">/tmp/host</span></code> 目录下。</p>
</div></blockquote>
<p><strong>Step3：检查共享是否成功</strong></p>
<blockquote>
<div><p>在openEuler Embedded中，执行如下命令：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ls /tmp/host
</pre></div>
</div>
<p>如能发现hello_openeuler.txt，则共享成功。</p>
</div></blockquote>
</div></blockquote>
</section>
<section id="id8">
<h2>6. 使能运行虚拟磁盘场景<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><p><strong>Step1：创建虚拟磁盘</strong></p>
<blockquote>
<div><p>要实现在openEuler Embedded中共享文件，使用共享文件系统是一个不错的方法。然而，qemu启动命令是将系统加载到内存，在某些应用场景下需要频繁启动openEuler Embedded，每次都需要重新设置共享文件夹，这样操作就显得繁琐。为了解决这个问题，可以考虑构建虚拟磁盘，以实现之前的设置永久保留。下面以SUSE Leap 15.4为例，介绍构建虚拟磁盘的过程：</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1"># 创建1G虚拟磁盘</span>
$ dd <span class="k">if</span><span class="o">=</span>/dev/zero <span class="nv">of</span><span class="o">=</span>virtual_disk.img <span class="nv">bs</span><span class="o">=</span>1M <span class="nv">count</span><span class="o">=</span><span class="m">1024</span>

<span class="c1"># 利用fdisk分区</span>
$ sudo fdisk virtual_disk.img

<span class="c1"># 将虚拟磁盘挂载</span>
$ sudo losetup -Pf --show virtual_disk.img

<span class="c1"># 格式化文件系统，可以通过ls /dev查看虚拟磁盘具体挂载在哪</span>
$ sudo mkfs.ext4 /dev/loop0p1

<span class="c1"># 挂载虚拟磁盘</span>
$ sudo mkdir /mnt/my_mount_point
$ sudo mount /dev/loop0p1 /mnt/my_mount_point
</pre></div>
</div>
</div></blockquote>
<p><strong>Step2：复制根文件系统</strong></p>
<blockquote>
<div><p>将 <code class="docutils literal notranslate"><span class="pre">openeuler-image-qemu-aarch64-*.rootfs.cpio.gz</span></code> 解压，随后拷贝到 <code class="docutils literal notranslate"><span class="pre">/mnt/my_mount_point</span></code> 目录下：</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1"># 在openeuler-image-qemu-aarch64-*.rootfs.cpio.gz所在目录下创建temp目录并复制</span>
$ mkdir temp
$ cp openeuler-image-qemu-aarch64-*.rootfs.cpio.gz temp <span class="o">&amp;&amp;</span> <span class="nb">cd</span> temp

<span class="c1"># 解压根文件系统压缩包</span>
$ gunzip -c openeuler-image-qemu-aarch64-*.rootfs.cpio.gz <span class="p">|</span> cpio -idmv
$ sudo cp -r * /mnt/my_mount_point
</pre></div>
</div>
<p>现在，已成功创建一个包含openEuler Embedded系统的虚拟磁盘。通过qemu你可以运行这个虚拟磁盘中的系统，并且不需要每次登录时都重新设置密码，设置的共享文件夹也会被保留。</p>
</div></blockquote>
<p><strong>Step3：启动虚拟磁盘</strong></p>
<blockquote>
<div><p>以下是用于启动虚拟磁盘的qemu命令。为了避免每次都输入冗长的命令，你可以在 <code class="docutils literal notranslate"><span class="pre">bashrc</span></code> 文件中设置一个alias命令来实现快速启动。</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>sudo qemu-system-aarch64 -M virt,gic-version<span class="o">=</span><span class="m">3</span> -m 1G -cpu cortex-a57 <span class="se">\</span>
   -append <span class="s1">&#39;maxcpus=3 root=/dev/vda1 rootfstype=ext4 rw&#39;</span> <span class="se">\</span>
   -smp <span class="m">4</span> -kernel zImage -dtb qemu_mcs.dtb -device virtio-net-device,netdev<span class="o">=</span>tap0 <span class="se">\</span>
   -netdev tap,id<span class="o">=</span>tap0,script<span class="o">=</span>/etc/qemu-ifup <span class="se">\</span>
   -drive <span class="nv">file</span><span class="o">=</span>virtual_disk.img,format<span class="o">=</span>raw -nographic<span class="s2">&quot;</span>
</pre></div>
</div>
<div class="line-block">
<div class="line">其中启动虚拟盘的关键参数如下：</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">root=/dev/vda1</span></code> ：指定了根文件系统的位置在挂载的虚拟磁盘的第一块分区上</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">-drive</span> <span class="pre">file=virtual_disk.img,format=raw</span></code> ：添加一个虚拟磁盘作为虚拟机的存储，虚拟磁盘文件为virtual_disk.img。</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">-netdev</span> <span class="pre">tap,id=tap0,script=/etc/qemu-ifup</span></code> ： 配置网络设备tap0，并指定用于管理该设备的脚本为/etc/qemu-ifup。</div>
</div>
</div></blockquote>
<p><strong>Step4：设置SSH密钥</strong></p>
<blockquote>
<div><p>尽管虚拟磁盘保存了密码，避免了每次登录时的密码设置，但在实际的调试过程中，通常需要频繁使用scp传输文件或者打开多个终端进行SSH连接。这时，为了简化操作，可以通过配置SSH密钥的方式实现无需输入密码的登录：</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1"># 生成密钥对</span>
$ ssh-keygen

<span class="c1"># 选择一个文件保存公钥位置，回车默认保存在/home/&lt;user&gt;/.ssh目录下</span>
$ Enter file <span class="k">in</span> which to save the key <span class="o">(</span>/home/&lt;user&gt;/.ssh/id_rsa<span class="o">)</span>:

<span class="c1"># 设置密钥短语，用于保护私钥，回车即可</span>
$ Enter passphrase <span class="o">(</span>empty <span class="k">for</span> no passphrase<span class="o">)</span>:

<span class="c1"># 再次输入密钥短语，回车即可</span>
$ Enter same passphrase again:
</pre></div>
</div>
<p>如果你看到类似以下的输出，表示SSH密钥已成功生成并配置完毕：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">Your identification has been saved in /home/&lt;user&gt;/.ssh/id_rsa</span>
<span class="go">Your public key has been saved in /home/&lt;user&gt;/.ssh/id_rsa.pub</span>
<span class="go">The key fingerprint is:</span>
<span class="go">SHA256:rOt1tPXpLY9nPiI4ASV/DLHV+5LG/9JBb96jhQu9fPU &lt;user&gt;@localhost.localdomain</span>
<span class="go">The key&#39;s randomart image is:</span>
<span class="go">+---[RSA 3072]----+</span>
<span class="go">|         ....    |</span>
<span class="go">|       . oo  .   |</span>
<span class="go">|        +.o   .  |</span>
<span class="go">|       o . o . . |</span>
<span class="go">|        S o o + .|</span>
<span class="go">|       . o o.*.++|</span>
<span class="go">|      . . =..o===|</span>
<span class="go">|       o + .oo*BE|</span>
<span class="go">|     .o   . .=*BO|</span>
<span class="go">+----[SHA256]-----+</span>
</pre></div>
</div>
<p>现在，你只需将 <code class="docutils literal notranslate"><span class="pre">/home/&lt;user&gt;/.ssh/id_rsa.pub</span></code> 文件的内容追加到虚拟磁盘中的 <code class="docutils literal notranslate"><span class="pre">/root/.ssh/authorized_keys</span></code> 文件中即可完成配置。这样，你的SSH密钥将被添加到虚拟机的授权密钥列表中，从而实现免密码的SSH登录。</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1">#将宿主机中的公钥输出，并复制</span>
$ cat ~/.ssh/id_rsa.pub

<span class="c1">#在qemu中创建目录，并复制内容</span>
$ mkdir /root/.ssh

<span class="c1"># 粘贴内容保存退出</span>
$ vi authorized_keys
</pre></div>
</div>
</div></blockquote>
<p>设置完成之后，宿主机和openEuler Embedded即可免密通信。</p>
</div></blockquote>
</section>
<section id="id9">
<h2>附录：QEMU常用的启动参数<a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><p>以下是一些常用的QEMU启动参数：</p>
<ul class="simple">
<li><p><strong>-M virt</strong>: 指定需要使用的machine类型，virt是qemu提供的一个通用machine，可以同时支持arm32和arm64（部分cortex不支持）， <code class="docutils literal notranslate"><span class="pre">-M</span> <span class="pre">help</span></code> 可以列出所有支持的machine列表</p></li>
<li><p><strong>-m 1G</strong>: 可选，可以通过修改此参数来增大OS的可用内存</p></li>
<li><p><strong>-cpu cortex-a57</strong>: 指定模拟的cpu类型，指定 <code class="docutils literal notranslate"><span class="pre">-M</span></code> 的情况下可以使用 <code class="docutils literal notranslate"><span class="pre">-cpu</span> <span class="pre">help</span></code> 查看当前machine支持的cpu类型</p></li>
<li><p><strong>-smp 2</strong>: 可选，可以修改OS的cpu数量，默认为1</p></li>
<li><p><strong>-append</strong>: 可选，指定内核的启动参数(cmdline)</p></li>
<li><p><strong>-kernel</strong>、<strong>-initrd</strong>: 分别用于指定OS的内核和文件系统</p></li>
<li><p><strong>-dtb</strong>: 可选，用于指定dtb(device tree)文件</p></li>
<li><p><strong>-d in_asm -D qemu.log</strong>: 可选，输出qemu在tcg模式下的”指令流”。 <code class="docutils literal notranslate"><span class="pre">-d</span></code> 选择指令流类型，可以用 <code class="docutils literal notranslate"><span class="pre">-d</span> <span class="pre">help</span></code> 查看支持的选项列表； <code class="docutils literal notranslate"><span class="pre">-D</span></code> 指定输出的文件名</p></li>
<li><p><strong>-s -S</strong>: 可选，调试参数。 <code class="docutils literal notranslate"><span class="pre">-S</span></code> 可以让qemu加载OS的zImage、initrd到指定位置后停止运行，等待gdb连接； <code class="docutils literal notranslate"><span class="pre">-s</span></code> 等价于 <code class="docutils literal notranslate"><span class="pre">--gdb</span> <span class="pre">tcp::1234</span></code> ，启动gdb server并默认监听1234端口</p></li>
<li><p><strong>-serial</strong>: 可选，用于串口重定向。不指定时默认为 <code class="docutils literal notranslate"><span class="pre">-serial</span> <span class="pre">stdio</span></code> ，即打印到标准输入输出。也可以重定向到tcp: <code class="docutils literal notranslate"><span class="pre">-serial</span> <span class="pre">tcp::1111,server,nowait</span></code> ，通过 <code class="docutils literal notranslate"><span class="pre">telnet</span> <span class="pre">localhost</span> <span class="pre">1111</span></code> 连接</p></li>
</ul>
</div></blockquote>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="index.html" class="btn btn-neutral float-left" title="QEMU仿真器的使用" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="qemu_debug.html" class="btn btn-neutral float-right" title="QEMU调试" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, openEuler Embedded.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    <span class="fa fa-book"> Other Versions</span>
    v: openEuler-24.09
    <span class="fa fa-caret-down"></span>
  </span>
  <div class="rst-other-versions">
    <dl>
      <dt>Branches</dt>
      <dd><a href="../../../../master/developer_guide/debug/qemu/qemu_start.html">master</a></dd>
      <dd><a href="../../../../openEuler-21.09/index.html">openEuler-21.09</a></dd>
      <dd><a href="../../../../openEuler-22.03-LTS/index.html">openEuler-22.03-LTS</a></dd>
      <dd><a href="../../../../openEuler-22.03-LTS-SP1/index.html">openEuler-22.03-LTS-SP1</a></dd>
      <dd><a href="../../../../openEuler-22.03-LTS-SP2/index.html">openEuler-22.03-LTS-SP2</a></dd>
      <dd><a href="../../../../openEuler-22.03-LTS-SP3/index.html">openEuler-22.03-LTS-SP3</a></dd>
      <dd><a href="../../../../openEuler-22.03-LTS-SP4/index.html">openEuler-22.03-LTS-SP4</a></dd>
      <dd><a href="../../../../openEuler-22.09/index.html">openEuler-22.09</a></dd>
      <dd><a href="../../../../openEuler-23.03/index.html">openEuler-23.03</a></dd>
      <dd><a href="../../../../openEuler-23.09/index.html">openEuler-23.09</a></dd>
      <dd><a href="../../../../openEuler-24.03-LTS/developer_guide/debug/qemu/qemu_start.html">openEuler-24.03-LTS</a></dd>
      <dd><a href="qemu_start.html">openEuler-24.09</a></dd>
      <dd><a href="../../../../openEuler-25.03/developer_guide/debug/qemu/qemu_start.html">openEuler-25.03</a></dd>
    </dl>
  </div>
</div>
<script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(false);
      });
  </script> 

</body>
</html>