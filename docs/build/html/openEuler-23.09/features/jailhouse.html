<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>轻量级虚拟化工具 Jailhouse &mdash; openEuler Embedded在线文档 1.0.0 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/custom.css" type="text/css" />
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="南向支持" href="../bsp/index.html" />
    <link rel="prev" title="clang/llvm 编译工具链支持" href="clang_llvm.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> openEuler Embedded在线文档
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">介绍与概述</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../introduction/index.html">总体介绍</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/index.html">快速上手</a></li>
<li class="toctree-l1"><a class="reference internal" href="../releases/index.html">版本说明</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq/index.html">常见问题</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">指导手册</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="index.html">关键特性</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="software_package_description.html">当前所支持的软件包</a></li>
<li class="toctree-l2"><a class="reference internal" href="mica/index.html">混合关键性系统框架 (MICA)</a></li>
<li class="toctree-l2"><a class="reference internal" href="lopper_devicetree.html">外设分区管理</a></li>
<li class="toctree-l2"><a class="reference internal" href="ros.html">嵌入式ROS运行时支持</a></li>
<li class="toctree-l2"><a class="reference internal" href="muslc.html">musl libc的支持</a></li>
<li class="toctree-l2"><a class="reference internal" href="distributed_softbus.html">分布式软总线</a></li>
<li class="toctree-l2"><a class="reference internal" href="preempt_rt.html">软实时系统介绍</a></li>
<li class="toctree-l2"><a class="reference internal" href="nativesdk.html">nativesdk 特性</a></li>
<li class="toctree-l2"><a class="reference internal" href="rust.html">支持Rust工具链</a></li>
<li class="toctree-l2"><a class="reference internal" href="qt5_wayland.html">嵌入式图形支持</a></li>
<li class="toctree-l2"><a class="reference internal" href="armnn.html">ArmNN的支持</a></li>
<li class="toctree-l2"><a class="reference internal" href="clang_llvm.html">clang/llvm 编译工具链支持</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">轻量级虚拟化工具 Jailhouse</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id1">总体介绍</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id2">Jailhouse 构建指导</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#oebuild">方法一：使用 oebuild 构建</a></li>
<li class="toctree-l4"><a class="reference internal" href="#mcs-sdk">方法二：使用 MCS 镜像的 SDK 构建</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id3">Jailhouse 使用指导</a></li>
<li class="toctree-l3"><a class="reference internal" href="#jailhouse-freertos">使用 Jailhouse 运行 FreeRTOS</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../bsp/index.html">南向支持</a></li>
<li class="toctree-l1"><a class="reference internal" href="../yocto/index.html">构建系统</a></li>
<li class="toctree-l1"><a class="reference internal" href="../develop_help/index.html">开发帮助</a></li>
<li class="toctree-l1"><a class="reference internal" href="../linux/index.html">使用与配置</a></li>
<li class="toctree-l1"><a class="reference internal" href="../infrastructure/index.html">基础设施</a></li>
<li class="toctree-l1"><a class="reference internal" href="../references/index.html">参考文献</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">oebuild 指导</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../oebuild/intro.html">简介</a></li>
<li class="toctree-l1"><a class="reference internal" href="../oebuild/userguide/index.html">用户指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="../oebuild/develop/index.html">开发者指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="../oebuild/release/index.html">版本变更日志</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">openEuler Embedded在线文档</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="index.html">关键特性</a> &raquo;</li>
      <li>轻量级虚拟化工具 Jailhouse</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="jailhouse">
<h1>轻量级虚拟化工具 Jailhouse<a class="headerlink" href="#jailhouse" title="Permalink to this headline">¶</a></h1>
<section id="id1">
<h2>总体介绍<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><p>Jailhouse 是一种轻量级虚拟化工具，与传统的全功能虚拟化解决方案（如 KVM 和 Xen）不同，它不提供完整的虚拟机管理和抽象功能，
而是一种基于Linux的静态分区虚拟化方案。Jailhouse 不支持任何设备模拟，不同客户虚拟机之间也不共享任何 CPU，所以也没有调度器。</p>
<p>Jailhouse 的工作是将硬件资源进行静态分区，每个分区称为一个 cell，每个 cell 之间是相互隔离开的，并且拥有自己的硬件资源(CPU、内存、外设等)，
运行在 cell 内的裸机应用程序或操作系统称为 inmate。
Jailhouse 的第一个 cell 叫 Root Cell，这是一个特权Cell，内部运行的是一个 Linux 系统，依赖该 Linux 接管系统硬件资源，以及进行硬件的初始化和启动。
除了 Root Cell 的其它 cell 统一称为 Non-root Cell，从 Root Cell 中获取系统资源，可独占或与 Root Cell 共享。</p>
</div></blockquote>
</section>
<hr class="docutils" />
<section id="id2">
<h2>Jailhouse 构建指导<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<section id="oebuild">
<h3>方法一：使用 oebuild 构建<a class="headerlink" href="#oebuild" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><p>openEuler Embedded 目前支持在 qemu-arm64 和 RPI4 上运行 Jailhouse，默认集成到了 openeuler-image-mcs 镜像，构建方法可参考 <a class="reference internal" href="mica/mica_build.html#mcs-build"><span class="std std-ref">mcs镜像构建指导</span></a>。</p>
<p>请注意，需要修改 oebuild 的编译配置文件 compile.yaml，把 MCS_FEATURES 中的 openamp 改成 jailhouse。</p>
</div></blockquote>
</section>
<section id="mcs-sdk">
<h3>方法二：使用 MCS 镜像的 SDK 构建<a class="headerlink" href="#mcs-sdk" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><p>按照 <a class="reference internal" href="mica/mica_build.html#mcs-build"><span class="std std-ref">mcs镜像构建指导</span></a> 构建出 MCS 镜像的SDK后，可以使用 SDK 交叉编译 Jailhouse，提升开发效率。步骤如下：</p>
<ol class="arabic">
<li><p>准备 Jailhouse 源码：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp"># </span>下载 Jailhouse 源码：
<span class="gp">$ </span>git clone https://gitee.com/src-openeuler/Jailhouse.git
<span class="gp">$ </span><span class="nb">cd</span> Jailhouse<span class="p">;</span> tar -xzf jailhouse-0.12.tar.gz

<span class="gp"># </span>打入 openEuler Embedded 的增强补丁：
<span class="gp">$ </span>curl -OL https://gitee.com/openeuler/yocto-meta-openeuler/raw/master/meta-openeuler/recipes-mcs/jailhouse/files/0001-driver-Add-support-for-remote-proc.patch
<span class="gp">$ </span><span class="nb">cd</span> jailhouse-0.12<span class="p">;</span> patch -p1 &lt; ../0001-driver-Add-support-for-remote-proc.patch
</pre></div>
</div>
</li>
</ol>
<blockquote>
<div><p>执行以上步骤后，代码目录为：jailhouse-0.12，即我们的构建目录。</p>
</div></blockquote>
<ol class="arabic" start="2">
<li><p>安装MCS镜像的SDK：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>sh openeuler-glibc-x86_64-openeuler-image-mcs-aarch64-qemu-aarch64-toolchain-*.sh
<span class="go">openEuler Embedded(openEuler Embedded Reference Distro) SDK installer version *</span>
<span class="go">===================================================================================</span>
<span class="go">Enter target directory for SDK (default: /opt/openeuler/oecore-x86_64): ./sdk</span>
<span class="go">You are about to install the SDK to &quot;/usr1/openeuler/sdk&quot;. Proceed [Y/n]? y</span>
<span class="go">Extracting SDK...................done</span>
<span class="go">Setting it up...SDK has been successfully set up and is ready to be used.</span>
<span class="go">Each time you wish to use the SDK in a new shell session, you need to source the environment setup script e.g.</span>
<span class="gp">$ </span>. /usr1/openeuler/sdk/environment-setup-aarch64-openeuler-linux
</pre></div>
</div>
<p>若 SDK 安装失败，请参考 <a class="reference internal" href="../getting_started/index.html#install-openeuler-embedded-sdk"><span class="std std-ref">安装SDK</span></a> 章节，排查是否缺少依赖软件包。</p>
<p>完成 SDK 安装后，按照提示，在 jailhouse-0.12 目录下，执行：</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>. /usr1/openeuler/sdk/environment-setup-aarch64-openeuler-linux

<span class="gp"># </span>需要自定义新增的cell文件，可以直接放在 configs/<span class="si">${</span><span class="nv">ARCH</span><span class="si">}</span> 目录中，然后执行编译：
<span class="gp">$ </span>make <span class="nv">KDIR</span><span class="o">=</span><span class="si">${</span><span class="nv">KERNEL_SRC</span><span class="si">}</span> -j<span class="k">$(</span>nproc<span class="k">)</span>
</pre></div>
</div>
<p>编译完成后，构建产物如下：</p>
<ul class="simple">
<li><p>cell文件：<cite>configs/${ARCH}</cite> 目录下；</p></li>
<li><p>Jailhouse 固件 jailhouse.bin ：在 <cite>hypervisor</cite> 目录下，需要拷贝到单板的 <cite>/lib/firmware</cite> 目录；</p></li>
<li><p>Jailhouse 驱动 jailhouse.ko ：在 <cite>driver</cite> 目录下；</p></li>
<li><p>用户态工具 jailhouse ：在 <cite>tools</cite> 目录。</p></li>
</ul>
</li>
</ol>
</div></blockquote>
</section>
</section>
<hr class="docutils" />
<section id="id3">
<h2>Jailhouse 使用指导<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><p>Jailhouse 构建完成后，生成文件分为三部分：</p>
<ul class="simple">
<li><p>Jailhouse 驱动和固件: <code class="docutils literal notranslate"><span class="pre">jailhouse.ko,</span> <span class="pre">jailhouse.bin</span></code>，提供用户态接口并初始化 hypervisor；</p></li>
<li><p>cell 和 guest 镜像：cell是镜像运行所需的系统资源的描述；guest镜像运行在cell内，包括裸机，RTOS等；</p></li>
<li><p>用户态工具 <code class="docutils literal notranslate"><span class="pre">jailhouse</span></code>：负责加载cell，运行镜像，查看运行状态等。</p></li>
</ul>
<p>openeuler-image-mcs 镜像中安装了可用的 cell 和 inmates-demo，下面以 <code class="docutils literal notranslate"><span class="pre">qemu-arm64</span></code> 为例，介绍 Jailhouse 的使用。</p>
<ol class="arabic">
<li><p>启动 QEMU</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">qemu-system-aarch64 -machine virt,gic-version=3,virtualization=on,its=off \</span>
<span class="go">   -cpu cortex-a57 -nographic -smp 4 -m 2G  \</span>
<span class="go">   -append &quot;console=ttyAMA0 loglevel=8 mem=1G&quot; \</span>
<span class="go">   -kernel zImage \</span>
<span class="go">   -initrd openeuler-image-mcs-qemu-aarch64-*.rootfs.cpio.gz</span>
</pre></div>
</div>
</li>
<li><p>初始化 Root Cell</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">jailhouse enable /usr/share/jailhouse/cells/qemu-arm64-openeuler-demo.cell</span>
</pre></div>
</div>
</li>
<li><p>初始化 Non-root Cell</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">jailhouse cell create /usr/share/jailhouse/cells/qemu-arm64-inmate-demo.cell</span>
</pre></div>
</div>
</li>
<li><p>加载 inmate</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">jailhouse cell load 1 /usr/share/jailhouse/inmates/uart-demo.bin</span>
<span class="go">jailhouse cell start 1</span>
</pre></div>
</div>
</li>
</ol>
<p>之后可以看到 uart-demo 的打印：</p>
<blockquote>
<div><div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">Started cell &quot;inmate-demo&quot;</span>
<span class="go">======= 0x0Hello 1 from cell!</span>
<span class="go">Hello 2 from cell!</span>
<span class="go">Hello 3 from cell!</span>
<span class="go">Hello 4 from cell!</span>
<span class="go">Hello 5 from cell!</span>
<span class="go">Hello 6 from cell!</span>
<span class="go">Hello 7 from cell!</span>
<span class="go">... ...</span>
</pre></div>
</div>
</div></blockquote>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>树莓派4B上 Jailhouse 的使用方法与 QEMU 类似，但需要提前分配保留内存（openeuler-image-mcs 默认已保留了 0x10000000-0x20000000）。</p>
</div>
</div></blockquote>
</section>
<hr class="docutils" />
<section id="jailhouse-freertos">
<h2>使用 Jailhouse 运行 FreeRTOS<a class="headerlink" href="#jailhouse-freertos" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><p>目前仅支持在 qemu-arm64 上通过 Jailhouse 运行 FreeRTOS。</p>
<ol class="arabic">
<li><p>添加 FreeRTOS 的构建</p>
<p>根据 <a class="reference internal" href="mica/mica_build.html#mcs-build"><span class="std std-ref">mcs镜像构建指导</span></a>，使用 oebuild 初始化编译环境。</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1"># qemu-arm64</span>
oebuild generate -p qemu-aarch64 -f openeuler-mcs -d &lt;build_arm64_mcs&gt;
</pre></div>
</div>
<p>进入 <code class="docutils literal notranslate"><span class="pre">&lt;build&gt;</span></code> 目录，添加 <code class="docutils literal notranslate"><span class="pre">meta-freertos</span></code></p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1"># BBLAYERS 中添加 meta-freertos</span>
vi conf/bblayers.conf

BBLAYERS ?<span class="o">=</span> <span class="s2">&quot; \</span>
<span class="s2">  ... ...</span>
<span class="s2">/usr1/openeuler/src/yocto-poky/../yocto-meta-openeuler/rtos/meta-freertos \</span>
<span class="s2">&quot;</span>
</pre></div>
</div>
</li>
<li><p>构建 jailhouse-freertos</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>oebuild bitbake jailhouse-freertos
</pre></div>
</div>
</li>
<li><p>加载 FreeRTOS</p>
<p>构建完成后，oebuild 构建目录下可以获取 <code class="docutils literal notranslate"><span class="pre">FreeRTOS.bin</span></code>，放到 qemu 上通过 Jailhouse 加载运行：</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="c1"># 获取 FreeRTOS.bin</span>
find . -name FreeRTOS.bin

<span class="c1"># 放到 qemu 上，通过 Jailhouse 加载运行</span>
jailhouse cell load <span class="m">1</span> FreeRTOS.bin
jailhouse cell start <span class="m">1</span>
</pre></div>
</div>
</li>
</ol>
</div></blockquote>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="clang_llvm.html" class="btn btn-neutral float-left" title="clang/llvm 编译工具链支持" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../bsp/index.html" class="btn btn-neutral float-right" title="南向支持" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, openEuler Embedded.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  
<div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    <span class="fa fa-book"> Other Versions</span>
    v: openEuler-23.09
    <span class="fa fa-caret-down"></span>
  </span>
  <div class="rst-other-versions">
    <dl>
      <dt>Branches</dt>
      <dd><a href="../../master/features/jailhouse.html">master</a></dd>
      <dd><a href="../../openEuler-21.09/index.html">openEuler-21.09</a></dd>
      <dd><a href="../../openEuler-22.03-LTS/index.html">openEuler-22.03-LTS</a></dd>
      <dd><a href="../../openEuler-22.03-LTS-SP1/index.html">openEuler-22.03-LTS-SP1</a></dd>
      <dd><a href="../../openEuler-22.03-LTS-SP2/features/jailhouse.html">openEuler-22.03-LTS-SP2</a></dd>
      <dd><a href="../../openEuler-22.03-LTS-SP3/features/jailhouse.html">openEuler-22.03-LTS-SP3</a></dd>
      <dd><a href="../../openEuler-22.03-LTS-SP4/features/jailhouse.html">openEuler-22.03-LTS-SP4</a></dd>
      <dd><a href="../../openEuler-22.09/index.html">openEuler-22.09</a></dd>
      <dd><a href="../../openEuler-23.03/features/jailhouse.html">openEuler-23.03</a></dd>
      <dd><a href="jailhouse.html">openEuler-23.09</a></dd>
      <dd><a href="../../openEuler-24.03-LTS/features/jailhouse.html">openEuler-24.03-LTS</a></dd>
    </dl>
  </div>
</div>
<script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(false);
      });
  </script> 

</body>
</html>