.. _board_kp920:

鲲鹏920
#######

基本介绍
========

鲲鹏920是目前业界领先的ARM-based处理器。该处理器采用7nm制造工艺，基于ARM架构授权，由华为公司自主设计完成，主频可达 2.6 GHz。详细配置可参考： `鲲鹏920 介绍 <https://www.hisilicon.com/cn/products/Kunpeng/Huawei-Kunpeng/Huawei-Kunpeng-920>`_

目前openEuler Embedded已经支持鲲鹏920的镜像构建、安装及运行。

____

构建说明
========

1. 参照 :ref:`oebuild_install` 完成oebuild安装，并详细了解构建过程

   .. code-block:: console

      # 例如
      $ oebuild init my_workspace

      # 上述命令没有指定分支，使用默认分支master
      $ cd xxx/my_workspace
      $ oebuild update

2. 依次执行以下命令完成构建

   .. code-block:: console

      # 生成kp920构建配置文件，若需额外加入特性，见-f列表(oebuild generate -l)，下例启用systemd和软实时功能
      $ oebuild generate -p kp920 -f systemd -f rt -d build_kp920

      # 按提示进入构建目录 build_kp920 后，执行如下命令进入bitbake环境，进入构建交互终端
      $ oebuild bitbake

      # 构建镜像
      $ bitbake openeuler-image

      # 构建sdk
      $ bitbake openeuler-image -c populate_sdk

   二进制产物介绍（对应output目录）：

   - ``openeuler-glibc-x86_64-openeuler-image-aarch64-kp920-toolchain-<version>.sh``: SDK工具链

   - ``openeuler-image-kp920-[时间戳].iso``: 适用鲲鹏920的ISO镜像，可直接用于部署

   - ``vmlinux``: 备用调试内核

   - ``Image``: 备用内核镜像

.. note::

   需要其他功能时，请在oebuild初始化时通过 ``-f features`` 添加对应的 feature。见-f列表(oebuild generate -l)

____

安装说明
========

1. 使用光驱安装：

  .. seealso::

     参考 :ref:`openEuler Embedded ISO 镜像安装说明 <iso_install>`，若使用 BMC 进行安装，请在 BMC 界面挂载光驱并选择光驱启动之后进行镜像安装。

2. 使用PXE安装：

   2.1 环境准备

     执行PXE安装需要准备一台PXE服务器，并确保需要安装镜像的设备可以与PXE服务器建立连接。PXE服务器用于存放 openEuler Embedded 镜像与各项配置文件，以便目标机器通过连接PXE服务器，进行PXE安装。

     .. note::

        下文将PXE服务器 IP 设置为 192.168.122.10，目标机器需要与PXE服务器在同网段下。

   2.2 PXE服务器配置

   1. 设置HTTP服务

      通过以下命令安装 httpd 服务，并进行启动和激活：

      .. code-block:: console

         # yum install -y httpd
         # systemctl start httpd
         # systemctl enable httpd

   2. 设置TFTP服务

      通过以下命令安装 tftp 服务，并进行相关配置：

      .. code-block:: console

         # yum install -y tftp-server xinetd
         # vim /etc/xinetd.d/tftp
           service tftp
           {
           socket_type = dgram
           protocol = udp
           wait = yes
           user = root
           server = /usr/sbin/in.tftpd
           server_args = -s /var/lib/tftpboot
           disable = no
           per_source = 11
           cps = 100 2
           flags = IPv4
           }
         # systemctl start tftp
         # systemctl enable tftp
         # systemctl start xinetd
         # systemctl status xinetd
         # systemctl enable xinetd

   3. 设置DHCP服务

      通过以下命令安装 dhcp 服务，并进行相关配置：

      .. code-block:: console

         # yum install -y dhcp
         # vim /etc/dhcp/dhcpd.conf
           authoritative
           ddns-update-style interim;
           ignore client-updates;
           subnet 192.168.122.0 netmask 255.255.255.0 {
               range 192.168.122.100 192.168.122.200;     # 动态IP范围
               next-server 192.168.122.10;                # PXE服务器IP地址
               filename "grubaa64.efi";                   # 默认的grub文件名，需要与下文中下载的grub文件名保持一致
               option routers 192.168.122.1;              # 网关地址
               option subnet-mask 255.255.255.0;          # 子网掩码
               default-lease-time 86400;
               max-lease-time 172800;
           }

         # systemctl start dhcpd
         # systemctl enable dhcpd

   4. 安装源的制作

      通过以下命令本地挂载 openEuler Embedded ISO镜像：

      .. code-block:: console

         # mkdir -p /mnt/iso
         # sudo mount openeuler_embedded.iso /mnt/iso    # 镜像名称请以实际为准

   5. 准备PXE安装所需文件

     a. 准备启动引导文件：

      下载 `grubaa64.efi <https://mirrors.nju.edu.cn/openeuler/openEuler-24.03-LTS/everything/aarch64/EFI/BOOT/grubaa64.efi>`_，之后，通过以下命令，将grub放在tftpboot目录，并创建grub.cfg：

      .. code-block:: console

         # 准备引导文件：
         # mkdir -p /var/lib/tftpboot
         # cp grubaa64.efi /var/lib/tftpboot
         # cp /mnt/iso/Image /var/lib/tftpboot
         # cp /mnt/iso/initrd /var/lib/tftpboot

         # 创建 grub.cfg
         # vim /var/lib/tftpboot/grub.cfg
           set default="1"

           function load_video {
             if [ x$feature_all_video_module = xy ]; then
               insmod all_video
             else
               insmod efi_gop
               insmod efi_uga
               insmod ieee1275_fb
               insmod vbe
               insmod vga
               insmod video_bochs
               insmod video_cirrus
             fi
           }

           load_video
           set gfxpayload=keep
           insmod gzio
           insmod part_gpt
           insmod ext2

           set timeout=60

           menuentry 'openEuler Embedded PXE Install' {
             linux /Image LABEL=install-pxe install_cfg=http://192.168.122.10/install_pxe.cfg  root=/dev/ram0 console=tty1 crashkernel=256M
             initrd /initrd
           }

     b. 准备 ISO 安装所需文件：

      PXE安装需要iso镜像、iso镜像的sha256校验值，以及配置文件 ``install_pxe.cfg``：

      .. code-block:: console

         # 假设iso镜像名为 openeuler_embedded.iso，sha256校验值文件为 openeuler_embedded.iso.sha256sum
         # cp openeuler_embedded.iso /var/lib/tftpboot
         # cp openeuler_embedded.iso.sha256sum /var/lib/tftpboot
         # chmod +rx /var/lib/tftpboot
         # chmod +r /var/lib/tftpboot/openeuler_embedded.iso

         # vim /var/lib/tftpboot/install_pxe.cfg
          INSTALL_ISO="openeuler_embedded.iso"                      # openEuler Embedded 镜像名称
          TARGET_DEVICE_NAME="sda"                                  # 目标机器预备安装系统的盘
          INSTALL_ISO_SHA256="openeuler_embedded.iso.sha256sum"     # 镜像sha256sum校验值文件

   2.3 安装步骤

   在 BMC 界面选择 ``PXE`` 启动项，重启系统开始自动化安装，系统安装完成后，会提示：``Installation successful. Remove your installation media and press ENTER to reboot.``
   之后可以在 BMC 界面选择 ``BIOS`` 启动项，按 Enter 键重启机器，重启后进入 BIOS 界面选择对应的磁盘启动项，进行系统启动。
